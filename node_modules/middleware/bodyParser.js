var url = require('url');
var formidable = require('formidable');
module.exports = {
	processRequest: function(req,mid){
		var form = new formidable.IncomingForm();
		form.parse(req,function(err,fields,files){
			req.fields = fields;
			req.files = files;
			mid.emit('done');
		});
		req.once('data',function(data){
			if(!req.body)
				req.body = data.toString();
			else
				req.body += data.toString();
		});
		req.once('end',function(){
            req.__get = url.parse(req.url,true).query;
			try{
				req.__post = url.parse('?'+req.body,true).query;
			}catch(e){
				req.__post = {};
			}
		});
	},
	type:'request'
};
